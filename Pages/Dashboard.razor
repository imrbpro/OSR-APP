@page "/"
@using OSR_APP.Services.Interface
@inject NavigationManager navigation
@inject ISnackbar Snackbar
@inject IFilterService filterService
<PageTitle>Dashboard</PageTitle>
<style>
    .filter-wrapper {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        align-content: center;
        align-items: stretch;
        justify-content: space-evenly;
    }
</style>
<div class="align-content-sm-around p-4 ">
    <h3>Reporting Filters</h3>
    <hr />
    <div class="filter-wrapper">
        <div class="row">
            <MudSelect T="NavigationPages" Label="Report" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" @bind-Value="SelectedValue">
                <MudSelectItem Value="@(new NavigationPages("ready"))" />
                <MudSelectItem Value="@(new NavigationPages("discounting"))" />
                <MudSelectItem Value="@(new NavigationPages("forward"))" />
                <MudSelectItem Value="@(new NavigationPages("Setoff"))" />
                <MudSelectItem Value="@(new NavigationPages("Closeout"))" />
                <MudSelectItem Value="@(new NavigationPages("outstandingfwd"))" />
            </MudSelect>
        </div>
        <br />
        <div class="row">
            <div class="col-md-2">Deal Number</div>
            <div class="col-md-4">
                <input class="form-control" @bind="dealNumber" />
            </div>
            <div class="col-md-2">To</div>
            <div class="col-md-4">
                <input class="form-control" @bind="dealNumberTo" />
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-2">Entry Date From</div>
            <div class="col-md-4">
                <InputDate @bind-Value="entryDateFrom" />
            </div>
            <div class="col-md-2">To</div>
            <div class="col-md-4">
                <InputDate @bind-Value="entryDateTo" />
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-2">Contact Date From</div>
            <div class="col-md-4">
                <InputDate @bind-Value="contactDateFrom" />
            </div>
            <div class="col-md-2">To</div>
            <div class="col-md-4">
                <InputDate @bind-Value="contactDateTo" />
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-2">Value Date From</div>
            <div class="col-md-4">
                <InputDate @bind-Value="valueDateFrom" />
            </div>
            <div class="col-md-2">To</div>
            <div class="col-md-4">
                <InputDate @bind-Value="valueDateTo" />
            </div>
        </div>

        <hr />
        <div class="row">
            <div class="col-md-2">Group By</div>
            <div class="col-md-10">
                <div class="form-check">
                    <InputRadioGroup @bind-Value="groupBy">
                        Portfolio <InputRadio Value="portfolio">
                            <label class="form-check-label">Portfolio</label>
                        </InputRadio>
                        <br />
                        Currency  <InputRadio Value="currency">
                            <label class="form-check-label">Currency</label>
                        </InputRadio>
                        <br />
                        DealNumber  <InputRadio Value="dealNumber">
                            <label class="form-check-label">DealNumber</label>
                        </InputRadio>
                    </InputRadioGroup>
                </div>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-6">
                <MudSelect class="form-control" T="string" Placeholder="Branch Code">
                        
                        @foreach (var brcode in branchCodeData)
                        {
                            <MudSelectItem Value="@brcode">@brcode</MudSelectItem>
                        }
                    
                </MudSelect>
            </div>
            <div class="col-md-6">
                <MudSelect class="form-control" T="string" Placeholder="Currency">
                   
                        @foreach (var currency in currencyData)
                        {
                            <MudSelectItem Value="@currency">@currency</MudSelectItem>
                        }
                    
                </MudSelect>
            </div>
        </div>

        <br />
        <div class="row">
            <div class="col-md-6">
                <MudSelect class="form-control" T="string" Placeholder="Portfolio">
                    
                        @foreach (var portfolio in portfolioData)
                        {
                            <MudSelectItem Value="@portfolio">@portfolio</MudSelectItem>
                        }
                    
                </MudSelect>
            </div>
            <div class="col-md-6">
                <MudSelect class="form-control" T="string" Placeholder="Trader">
                    
                        @foreach (var trader in traderData)
                        {
                            <MudSelectItem Value="@trader">@trader</MudSelectItem>
                        }
                   
                </MudSelect>
            </div>
        </div>

        <br />
        <div class="row">
            <div class="col-md-6">
                <select class="form-control" @bind="customer">
                    <option value="0">Select Customer</option>
                </select>
            </div>
            <div class="col-md-6">
                <select class="form-control" @bind="ps">
                    <option value=0>Purchase</option>
                    <option value=1>Sale</option>
                </select>
            </div>
        </div>

        <br />
        <button class="cssbuttons-io-button" @onclick="GenerateReport">
            Get Report
            <div class="icon">
                <svg height="24"
                     width="24"
                     viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"
                          fill="currentColor"></path>
                </svg>
            </div>
        </button>



    </div>
</div>

@code {
    private string value { get; set; } = "Select Option";
    private NavigationPages SelectedValue;

    string? dealNumber { get; set; } = "0";
    string? dealNumberTo { get; set; } = "0";
    string? groupBy { get; set; } = "0";

    DateTime entryDateFrom { get; set; } = DateTime.Now;
    DateTime entryDateTo { get; set; } = DateTime.Now;
    DateTime contactDateFrom { get; set; } = DateTime.Now;
    DateTime contactDateTo { get; set; } = DateTime.Now;
    DateTime valueDateFrom { get; set; } = DateTime.Now;
    DateTime valueDateTo { get; set; } = DateTime.Now;

    bool branchCode { get; set; } = false;
    bool currency { get; set; } = false;
    bool portfolio { get; set; } = false;
    bool trader { get; set; } = false;
    string customer { get; set; } = "0";
    int? ps { get; set; } = 0;

    private bool IsLoading = false;

    List<string> branchCodeData = new List<string>();
    List<string> currencyData = new List<string>(); 
    List<string> portfolioData = new List<string>();
    List<string> traderData = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        try
        {
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadDataAsync()
    {
        var branchCodeTask = filterService.GetBranchCode();
        var currencyTask = filterService.GetCurrency();
        var portfolioTask = filterService.GetPortfolio();
        var traderTask = filterService.GetTrader();

        await Task.WhenAll(branchCodeTask, currencyTask, portfolioTask, traderTask);

        branchCodeData = (await branchCodeTask)?.GetValueOrDefault("branchCodeData").ToList<string>();
        currencyData = (await currencyTask)?.GetValueOrDefault("currencyData").ToList<string>();
        portfolioData = (await portfolioTask)?.GetValueOrDefault("portfolioData").ToList<string>();
        traderData = (await traderTask)?.GetValueOrDefault("traderData").ToList<string>();
    }

    private void GenerateReport()
    {
        if (SelectedValue != null)
        {
            switch (SelectedValue.Name.ToString().ToLower())
            {
                case "ready":
                    navigation.NavigateTo(navigation.ToAbsoluteUri($"/ready/{dealNumber}/{dealNumberTo}/{entryDateFrom:yyyy-MM-dd}/{entryDateTo:yyyy-MM-dd}/{valueDateFrom:yyyy-MM-dd}/{valueDateTo:yyyy-MM-dd}/{branchCode}/{currency}/{portfolio}/{trader}/{customer}/{ps}/{ps}").ToString());
                    break;
                case "discounting":
                    navigation.NavigateTo(navigation.ToAbsoluteUri($"/discounting/{dealNumber}/{dealNumberTo}/{entryDateFrom:yyyy-MM-dd}/{entryDateTo:yyyy-MM-dd}/{valueDateFrom:yyyy-MM-dd}/{valueDateTo:yyyy-MM-dd}/{branchCode}/{currency}/{portfolio}/{trader}/{trader}/{customer}/{ps}/{ps}").ToString());
                    break;
                case "forward":
                    navigation.NavigateTo(navigation.ToAbsoluteUri($"/forward/{dealNumber}/{dealNumberTo}/{entryDateFrom:yyyy-MM-dd}/{entryDateTo:yyyy-MM-dd}/{contactDateFrom:yyyy-MM-dd}/{contactDateTo:yyyy-MM-dd}/{valueDateFrom:yyyy-MM-dd}/{valueDateTo:yyyy-MM-dd}/{currency}/{portfolio}/{trader}/{trader}/{customer}/{ps}").ToString());
                    break;
                case "setoff":
                    navigation.NavigateTo(navigation.ToAbsoluteUri($"/setoff/{dealNumber}/{dealNumberTo}/{contactDateFrom:yyyy-MM-dd}/{contactDateTo:yyyy-MM-dd}/{valueDateFrom:yyyy-MM-dd}/{valueDateTo:yyyy-MM-dd}/{entryDateFrom:yyyy-MM-dd}/{entryDateTo:yyyy-MM-dd}/{currency}/{portfolio}/{trader}/{customer}/{ps}").ToString());
                    break;
                case "closeout":
                    navigation.NavigateTo(navigation.ToAbsoluteUri($"/closeout/{dealNumber}/{dealNumberTo}/{contactDateFrom:yyyy-MM-dd}/{contactDateTo:yyyy-MM-dd}/{valueDateFrom:yyyy-MM-dd}/{valueDateTo:yyyy-MM-dd}/{entryDateFrom:yyyy-MM-dd}/{entryDateTo:yyyy-MM-dd}/{currency}/{portfolio}/{trader}/{customer}/{ps}").ToString());
                    break;
                case "outstandingfwd":
                    navigation.NavigateTo(navigation.ToAbsoluteUri($"/outstandingfwd/{dealNumber}/{dealNumberTo}/{contactDateFrom:yyyy-MM-dd}/{contactDateTo:yyyy-MM-dd}/{valueDateFrom:yyyy-MM-dd}/{valueDateTo:yyyy-MM-dd}/{entryDateFrom:yyyy-MM-dd}/{entryDateTo:yyyy-MM-dd}/{currency}/{portfolio}/{branchCode}/{trader}/{customer}/{ps}").ToString());
                    break;

            }
        }
        else
        {
            Snackbar.Add("Please Select Report First...", Severity.Error);
        }
    }

    public class NavigationPages
    {
        public NavigationPages(string name)
        {
            Name = name;
        }

        public readonly string Name;

        public override bool Equals(object o)
        {
            var other = o as NavigationPages;
            return other?.Name == Name;
        }

        public override int GetHashCode() => Name?.GetHashCode() ?? 0;

        public override string ToString() => Name;
    }
}
